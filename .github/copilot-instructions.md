# SmartClockIOT - AI Coding Instructions

## Project Overview
PlatformIO project for **ESP32-S3** (Arduino framework) implementing a smart clock with MQTT, Weather, Alarm, and **Pomodoro Timer**.
- **Board**: `esp32-s3-devkitc-1` (16MB Flash, OPI PSRAM).
- **Display**: LovyanGFX (DMA enabled) + LVGL 8.3.
- **UI**: Generated by SquareLine Studio in `src/UI/`.

## Architecture & Components

### 1. Core (`src/main.cpp`)
- **Display**: Uses **Double Buffering** (`buf`, `buf2`) in PSRAM for smooth LVGL rendering.
- **Sensors**:
  - **Ultrasonic (HC-SR05)**: Presence detection (Trig: 18, Echo: 17). *Note: Uses 5ms timeout to prevent UI blocking.*
  - **LDR**: Ambient light sensing (Pin 7) for auto-brightness.
  - **RTC (DS3231)**: Timekeeping (SDA: 42, SCL: 41).
  - **RGB LED**: Status (Pin 48).

### 2. Services
- **MQTT (`src/MqttService.cpp`)**:
  - Connects to `broker.hivemq.com`.
  - Topics: `out/weather`, `out/air-quality`, `set/clock`, `set/alarm`.
  - JSON parsing via `ArduinoJson`.
- **Timer (`src/TimerService.cpp`)**:
  - Manages Countdown/Pomodoro logic.
  - State machine: `timerActive`, `timerRunning`.
  - Updates UI labels directly (e.g., `ui_countdownTimeBig2`).

### 3. User Interface (`src/UI/`)
- **Generated Code**: Do not manually edit `ui_*.c` files unless necessary; prefer logic in `src/`.
- **Access**: UI widgets are global pointers (e.g., `ui_LabelTime`).
- **Thread Safety**: LVGL is not thread-safe. UI updates must happen in the main loop or be carefully managed.

## Development Workflows

### Build & Flash
- **Build**: `pio run`
- **Upload**: `pio run -t upload`
- **Monitor**: `pio device monitor` (Baud: 115200)

### Critical Conventions
1.  **Non-Blocking Code**:
    -   `loop()` must remain fast for `lv_timer_handler()`.
    -   Avoid `delay()`. Use `millis()` for timing (see `TimerService.cpp`).
    -   Ultrasonic `pulseIn` is capped at 5ms (85cm max) to avoid frame drops.
2.  **UI Safety**:
    -   Always check if a UI object exists before accessing: `if (ui_LabelName) lv_label_set_text(...)`.
    -   Use `_ui_flag_modify` for showing/hiding widgets safely.
3.  **Memory**:
    -   Large buffers (like display buffers) must be in PSRAM (`-DBOARD_HAS_PSRAM`).
    -   `ArduinoJson` documents can be large; watch stack usage.

## Key Files
-   `platformio.ini`: Build flags (`-Ofast`, `-D LV_CONF_PATH`).
-   `src/main.cpp`: Hardware setup, main loop, sensor polling.
-   `src/TimerService.cpp`: Timer logic and specific UI interactions.
-   `include/LGFX_Setup.h`: Low-level display driver config.
